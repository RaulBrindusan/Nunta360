rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection
    match /users/{userId} {
      allow read: if request.auth.uid == userId;
      allow create: if request.auth.uid == userId
                    && request.resource.data.email == request.auth.token.email;
      allow update: if request.auth.uid == userId;
      allow delete: if false;

      // Events subcollection
      match /events/{eventId} {
        allow read: if request.auth.uid == userId;
        allow create: if request.auth.uid == userId
                      && request.resource.data.userId == userId;
        allow update: if request.auth.uid == userId;
        allow delete: if request.auth.uid == userId;
      }

      // Guests subcollection
      match /guests/{guestId} {
        function isValidGuest() {
          let data = request.resource.data;
          return data.familySize >= 1
                 && (data.isFamily == false ? data.familySize == 1 : data.familySize > 1)
                 && data.status in ['in_asteptare', 'confirmat', 'refuzat']
                 && data.menuPreference in ['normal', 'vegetarian', 'vegan', 'fara_gluten', 'alte_alergii'];
        }

        allow read: if request.auth.uid == userId;
        allow create: if request.auth.uid == userId
                      && request.resource.data.userId == userId
                      && isValidGuest();
        allow update: if request.auth.uid == userId
                      && isValidGuest();
        allow delete: if request.auth.uid == userId;
      }

      // Table guests subcollection
      match /tableGuests/{tableGuestId} {
        allow read: if request.auth.uid == userId;
        allow create: if request.auth.uid == userId
                      && request.resource.data.userId == userId;
        allow update: if request.auth.uid == userId;
        allow delete: if request.auth.uid == userId;
      }

      // Budget subcollection
      match /budget/{budgetId} {
        allow read: if request.auth.uid == userId;
        allow create: if request.auth.uid == userId
                      && request.resource.data.userId == userId;
        allow update: if request.auth.uid == userId;
        allow delete: if request.auth.uid == userId;

        // Budget categories subcollection
        match /categories/{categoryId} {
          function isValidCategory() {
            let data = request.resource.data;
            return data.category in ['Locație', 'Catering', 'Decorațiuni & Flori', 'Fotograf & Videograf', 'Muzică & Entertainment', 'Rochie & Costum', 'Altele']
                   && data.allocated >= 0;
          }

          allow read: if request.auth.uid == userId;
          allow create: if request.auth.uid == userId
                        && request.resource.data.userId == userId
                        && isValidCategory();
          allow update: if request.auth.uid == userId
                        && isValidCategory();
          allow delete: if request.auth.uid == userId;
        }
      }

      // Expenses subcollection
      match /expenses/{expenseId} {
        function isValidExpense() {
          let data = request.resource.data;
          return data.category in ['Locație', 'Catering', 'Decorațiuni & Flori', 'Fotograf & Videograf', 'Muzică & Entertainment', 'Rochie & Costum', 'Altele']
                 && data.price >= 0;
        }

        allow read: if request.auth.uid == userId;
        allow create: if request.auth.uid == userId
                      && request.resource.data.userId == userId
                      && isValidExpense();
        allow update: if request.auth.uid == userId
                      && isValidExpense();
        allow delete: if request.auth.uid == userId;
      }
    }

    // QR Pages collection - for guest upload pages
    match /qr_pages/{pageId} {
      function isValidQRPage() {
        let data = request.resource.data;
        return data.slug is string
               && data.slug.size() == 16
               && data.isActive is bool;
      }

      // Allow anyone to read (guests need to validate slug)
      allow read: if true;

      // Only authenticated users can create their own QR page
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid
                    && isValidQRPage();

      // Only owner can update/delete
      allow update: if request.auth.uid == resource.data.userId
                    && isValidQRPage();
      allow delete: if request.auth.uid == resource.data.userId;
    }

    // Uploaded Files collection - for guest uploaded media
    match /uploaded_files/{fileId} {
      function isValidUploadedFile() {
        let data = request.resource.data;
        return data.fileName is string
               && data.fileType is string
               && data.fileSize is number
               && data.fileSize <= 52428800  // 50MB max
               && (data.fileType.matches('image/.*') || data.fileType.matches('video/.*'))
               && data.downloadURL is string
               && data.storagePath is string
               && data.pageId is string
               && data.slug is string;
      }

      // Anyone can create (guests upload files)
      allow create: if isValidUploadedFile();

      // Only page owner can read uploaded files
      allow read: if request.auth != null
                  && exists(/databases/$(database)/documents/qr_pages/$(resource.data.pageId))
                  && get(/databases/$(database)/documents/qr_pages/$(resource.data.pageId)).data.userId == request.auth.uid;

      // Only page owner can delete uploaded files
      allow delete: if request.auth != null
                    && exists(/databases/$(database)/documents/qr_pages/$(resource.data.pageId))
                    && get(/databases/$(database)/documents/qr_pages/$(resource.data.pageId)).data.userId == request.auth.uid;

      // No updates allowed
      allow update: if false;
    }
  }
}
